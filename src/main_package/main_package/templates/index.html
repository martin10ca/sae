<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SAE Speed Control</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial;
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card {
            background: white;
            padding: 35px;
            width: 420px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        h2, h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #4a4a4a;
        }

        .slider {
            width: 100%;
        }

        .speed-box {
            width: 80px;
            padding: 10px;
            text-align: center;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .set-btn {
            padding: 10px 20px;
            background: #6a8dff;
            color: white;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        /* STOP SOBRIO */
        .stop-btn {
            width: 100%;
            padding: 10px;
            background: #444;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
        }

        .status-box {
            background: #f4f6fa;
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #6a5acd;
        }

        .sensor-panel {
            margin-top: 25px;
            padding: 15px;
            background: #f7f9fc;
            border-radius: 10px;
            border-left: 4px solid #6a5acd;
        }

        .sensor-item {
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* TCRT */
        .tcrt-block {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            padding-left: 4px;
        }

        .tcrt-cell {
            width: 22px;
            height: 22px;
            border: 1px solid black;
            border-radius: 4px;
            background: white;
        }
    </style>
</head>

<body>
<div class="card">

    <h2>ðŸš— SAE Speed Control</h2>
    <h3 id="speed_display">0%</h3>

    <!-- SOLO SLIDER + INPUT -->
    <input type="range" id="speed_slider" class="slider" min="0" max="100" value="0"
           oninput="syncSlider()">

    <div style="display:flex; margin-top:10px;">
        <input type="number" id="speed_input" class="speed-box" value="0" min="0" max="100" oninput="syncInput()">
        <button class="set-btn" onclick="sendSpeed()">SET SPEED</button>
    </div>

    <button class="stop-btn" onclick="emergencyStop()">STOP</button>

    <!-- STATUS PANEL -->
    <div class="status-box">
        <h4>CURRENT STATUS</h4>
        <p id="status_text">---</p>
    </div>

    <!-- SENSOR PANEL -->
    <div class="sensor-panel">
        <h3>Sensor Readings</h3>

        <!-- TCRT -->
        <div class="sensor-item">
            <strong>TCRT5000 Line Sensors:</strong>
            <div id="tcrt_block" class="tcrt-block">
                <div class="tcrt-cell"></div>
                <div class="tcrt-cell"></div>
                <div class="tcrt-cell"></div>
                <div class="tcrt-cell"></div>
                <div class="tcrt-cell"></div>
            </div>
        </div>

        <!-- DISTANCES -->
        <div class="sensor-item">
            <strong>Distance Sensors (ADS1115):</strong>
            <ul id="distance_list"></ul>
        </div>
    </div>

    <!-- MPU GRAPH -->
    <div class="sensor-panel">
        <h3>AceleraciÃ³n Z (MPU6050)</h3>
        <canvas id="accelChart" width="380" height="200"></canvas>
    </div>

</div>

<script>
    // ---------------- SLIDER â†” INPUT SYNC ----------------
    function syncSlider() {
        let v = document.getElementById("speed_slider").value;
        document.getElementById("speed_input").value = v;
        document.getElementById("speed_display").innerText = v + "%";
    }

    function syncInput() {
        let v = document.getElementById("speed_input").value;
        if (v < 0) v = 0;
        if (v > 100) v = 100;
        document.getElementById("speed_slider").value = v;
        document.getElementById("speed_display").innerText = v + "%";
    }

    // ---------------- SEND SPEED ----------------
    function sendSpeed() {
        let val = document.getElementById("speed_input").value;

        fetch("/set_speed", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({speed: val})
        });
    }

    // ---------------- STOP BUTTON ----------------
    function emergencyStop() {
        fetch("/set_speed", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({speed: 0})
        });

        document.getElementById("speed_slider").value = 0;
        document.getElementById("speed_input").value = 0;
        document.getElementById("speed_display").innerText = "0%";
    }

    // ---------------- MPU GRAPH ----------------
    const ctx = document.getElementById("accelChart").getContext("2d");

    let accelData = {
        labels: [],
        datasets: [{
            label: "AceleraciÃ³n Z (m/sÂ²)",
            data: [],
            borderColor: "rgb(75, 192, 192)",
            tension: 0.2
        }]
    };

    let accelChart = new Chart(ctx, {
        type: "line",
        data: accelData,
        options: {
            animation: false,
            responsive: true,
            scales: {
                x: { title: { text: "Tiempo (s)", display: true } },
                y: { title: { text: "AceleraciÃ³n Z", display: true } }
            }
        }
    });

    let timeCounter = 0;
    function updateChart(z_value) {
        accelData.labels.push((timeCounter++ * 0.5).toFixed(1));
        accelData.datasets[0].data.push(z_value);

        if (accelData.labels.length > 80) {
            accelData.labels.shift();
            accelData.datasets[0].data.shift();
        }

        accelChart.update();
    }

    // ---------------- LIVE STATUS ----------------
    function updateStatus() {
        fetch("/status")
            .then(r => r.json())
            .then(data => {

                document.getElementById("speed_display").innerText = data.speed + "%";
                document.getElementById("status_text").innerText = data.status;

                // TCRT update
                const cells = document.querySelectorAll("#tcrt_block .tcrt-cell");
                for (let i = 0; i < 5; i++) {
                    cells[i].style.background = (data.tcrt[i] === 0 ? "black" : "white");
                }

                // Distance with ONE DECIMAL
                let list = document.getElementById("distance_list");
                list.innerHTML = "";
                for (const [topic, value] of Object.entries(data.dist_sensors)) {
                    let li = document.createElement("li");
                    li.textContent = `${topic}: ${parseFloat(value).toFixed(1)} cm`;
                    list.appendChild(li);
                }

                updateChart(data.mpu_accel_z);
            });
    }

    setInterval(updateStatus, 500);
</script>

</body>
</html>
